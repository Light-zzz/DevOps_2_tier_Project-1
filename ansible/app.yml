---
- name: Configure Application VM
  hosts: App
  become: yes

  vars:
    app_dir: /opt/flask-app

  tasks:

  - name: Update apt cache
    apt:
      update_cache: yes

  - name: Install required packages
    apt:
      name:
        - docker.io
        - docker-compose
        - python3-pip
      state: present

  - name: Start & enable Docker
    service:
      name: docker
      state: started
      enabled: yes

  - name: Add ubuntu user to docker group
    user:
      name: ubuntu
      groups: docker
      append: yes

  - name: Create application directory
    file:
      path: "{{ app_dir }}"
      state: directory
      owner: ubuntu
      group: ubuntu

  - name: Copy Docker Compose file
    copy:
      src: ../docker/docker-compose.yml
      dest: "{{ app_dir }}/docker-compose.yml"
      owner: ubuntu
      group: ubuntu

  - name: Copy Flask app
    copy:
      src: ../docker/app
      dest: "{{ app_dir }}"
      owner: ubuntu
      group: ubuntu

  - name: Build & start Flask + MySQL containers
    shell: |
      docker-compose up -d
    args:
      chdir: "{{ app_dir }}"
