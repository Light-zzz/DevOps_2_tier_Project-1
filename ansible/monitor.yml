---
- name: Configure Monitoring VM
  hosts: monitoring
  become: yes

  tasks:

  - name: Update apt cache
    apt:
      update_cache: yes

  - name: Install required packages
    apt:
      name:
        - wget
        - curl
        - unzip
        - apt-transport-https
      state: present

  # ---------------- PROMETHEUS ----------------
  - name: Create Prometheus user
    user:
      name: prometheus
      system: yes
      shell: /sbin/nologin

  - name: Download Prometheus
    get_url:
      url: https://github.com/prometheus/prometheus/releases/download/v2.48.0/prometheus-2.48.0.linux-amd64.tar.gz
      dest: /tmp/prometheus.tar.gz

  - name: Extract Prometheus
    unarchive:
      src: /tmp/prometheus.tar.gz
      dest: /opt/
      remote_src: yes

  - name: Create Prometheus config
    copy:
      dest: /opt/prometheus.yml
      content: |
        global:
          scrape_interval: 15s
        scrape_configs:
          - job_name: "node"
            static_configs:
              - targets: ["localhost:9100"]

  - name: Start Prometheus
    shell: |
      nohup /opt/prometheus-2.48.0.linux-amd64/prometheus \
      --config.file=/opt/prometheus.yml \
      > /var/log/prometheus.log 2>&1 &

  # ---------------- GRAFANA ----------------
  - name: Add Grafana repo
    shell: |
      wget -q -O - https://packages.grafana.com/gpg.key | apt-key add -
      echo "deb https://packages.grafana.com/oss/deb stable main" > /etc/apt/sources.list.d/grafana.list

  - name: Install Grafana
    apt:
      update_cache: yes
      name: grafana
      state: present

  - name: Start & enable Grafana
    service:
      name: grafana-server
      state: started
      enabled: yes

  # ---------------- CLOUDWATCH AGENT ----------------
  - name: Download CloudWatch Agent
    get_url:
      url: https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
      dest: /tmp/cw-agent.deb

  - name: Install CloudWatch Agent
    apt:
      deb: /tmp/cw-agent.deb

  - name: Configure CloudWatch Agent
    copy:
      dest: /opt/aws/amazon-cloudwatch-agent/bin/config.json
      content: |
        {
          "logs": {
            "logs_collected": {
              "files": {
                "collect_list": [
                  {
                    "file_path": "/var/log/syslog",
                    "log_group_name": "ec2-syslog",
                    "log_stream_name": "{instance_id}"
                  }
                ]
              }
            }
          }
        }

  - name: Start CloudWatch Agent
    shell: |
      /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
      -a fetch-config -m ec2 \
      -c file:/opt/aws/amazon-cloudwatch-agent/bin/config.json -s
