pipeline {
  agent any

  parameters {
    choice(name: 'ACTION', choices: ['up', 'down'], description: 'Deploy or Destroy App means, "UP or DOWN"')
  }

  environment {
    APP_VM = '51.20.115.211'
  }

  stages {

    stage('Copy App Files to App VM') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: 'ansible-ssh',
          keyFileVariable: 'SSH_KEY'
        )]) {
          sh '''
          chmod 600 $SSH_KEY
          ssh -o StrictHostKeyChecking=no -i $SSH_KEY ubuntu@$APP_VM "mkdir -p /home/ubuntu/app"
          rsync -avz --delete -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no" ./ ubuntu@$APP_VM:/home/ubuntu/app/
          '''
        }
      }
    }

    stage('Docker Compose') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: 'ansible-ssh',
          keyFileVariable: 'SSH_KEY'
        )]) {
          sh '''
          ssh -i $SSH_KEY ubuntu@$APP_VM << 'EOF'
          cd /home/ubuntu/app/app
          if [ "${ACTION}" = "up" ]; then
            docker compose down || true
            docker compose up -d --build
          else
            docker compose down
          fi
          EOF
          '''
        }
      }
    }
  }

  post {
    success {
      echo "✅ Deployment of Flask and MySql successful"
    }
    failure {
      echo "❌ Deployment failed"
    }
  }
}
