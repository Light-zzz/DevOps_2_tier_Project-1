pipeline {
  agent any

  parameters {
    choice(name: 'ACTION', choices: ['up', 'down'], description: 'Deploy or Remove App means, "UP or DOWN"')
  }

  stages {

    stage('Copy App Files to App VM') {
      steps {
        withCredentials([sshUserPrivateKey(
          credentialsId: 'ansible-ssh',
          keyFileVariable: 'SSH_KEY'
        )]) {
          sh """
          chmod 600 \$SSH_KEY
          ssh -o StrictHostKeyChecking=no -i \$SSH_KEY ubuntu@51.20.115.211 'mkdir -p /home/ubuntu/app'
          rsync -avz --delete -e "ssh -i \$SSH_KEY -o StrictHostKeyChecking=no" ./ ubuntu@51.20.115.211:/home/ubuntu/app/
          """
        }
      }
    }

    stage('Docker Compose') {
        steps {
            withCredentials([sshUserPrivateKey(
                credentialsId: 'ansible-ssh',
                keyFileVariable: 'SSH_KEY'
            )]) {
                sh """
                chmod 600 \$SSH_KEY
                ssh -o StrictHostKeyChecking=no -i \$SSH_KEY ubuntu@51.20.115.211 \
                  "cd /home/ubuntu/app/app && docker-compose down || true && docker-compose build && docker-compose up -d"
                """
            }
        }
    }
  }

  post {
    success {
      echo "✅ Deployment of Flask and MySql completed successfully"
    }
    failure {
      echo "❌ Deployment failed"
    }
  }
}
