pipeline {
    agent any

    parameters {
        booleanParam(
            name: 'autoApprove',
            defaultValue: false,
            description: 'Automatically run apply without approval?'
        )
        choice(
            name: 'action',
            choices: ['apply', 'destroy'],
            description: 'Select Terraform action'
        )
    }

    environment {
        TERRAFORM_VERSION = "1.6.6"
        TF_DIR            = "terraform"
        AWS_DEFAULT_REGION = "eu-north-1"
        TF_PLUGIN_TIMEOUT = "300s"
        ANSIBLE_DIR       = "ansible"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/Light-zzz/DevOps_2_tier_Project-1.git'
            }
        }

        stage('Install Terraform') {
            steps {
                sh '''
                set -e

                if ! command -v terraform >/dev/null 2>&1; then
                  curl -O https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
                  unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip
                  mv terraform $HOME/terraform
                  export PATH=$HOME:$PATH
                fi

                terraform version
                '''
            }
        }

        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform init'
                }
            }
        }

        stage('Terraform Validate') {
            steps {
                dir("${TF_DIR}") {
                    sh 'terraform validate'
                }
            }
        }

        stage('Terraform Plan') {
            when {
                expression { params.action == 'apply' }
            }
            steps {
                dir("${TF_DIR}") {
                    sh '''
                    terraform plan -out=tfplan
                    terraform show -no-color tfplan > tfplan.txt
                    '''
                }
            }
        }

        stage('Terraform Apply / Destroy') {
            steps {
                dir("${TF_DIR}") {
                    script {

                        if (params.action == 'apply') {

                            if (!params.autoApprove) {
                                def plan = readFile 'tfplan.txt'
                                input(
                                    message: "Review Terraform plan before apply",
                                    parameters: [
                                        text(
                                            name: 'Terraform Plan',
                                            description: 'Terraform execution plan',
                                            defaultValue: plan
                                        )
                                    ]
                                )
                            }

                            sh 'terraform apply -input=false tfplan'

                        } else if (params.action == 'destroy') {
                            sh 'terraform destroy --auto-approve'
                        } else {
                            error "Invalid action selected"
                        }
                    }
                }
            }
        }

        stage('Save Terraform Outputs to Ansible') {
            when {
                expression { params.action == 'apply' }
            }
            steps {
                dir("${TF_DIR}") {
                    sh '''
                    set -e
                    mkdir -p ../${ANSIBLE_DIR}

                    APP_IP=$(terraform output -raw app_vm_public_ip)
                    MONITOR_IP=$(terraform output -raw monitor_vm_public_ip)

                    cat <<EOF > ../${ANSIBLE_DIR}/inventory.ini
[app]
${APP_IP} ansible_user=ubuntu

[monitor]
${MONITOR_IP} ansible_user=ubuntu
EOF
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Terraform completed successfully"
        }
        failure {
            echo "❌ Terraform pipeline failed"
        }
    }
}
